!function(e){"use strict";AWEContent.Views.Dialog=Backbone.View.extend({initialize:function(){e("body").append(this.$el)},events:{"click .pp-footer > a.pp-save":"save","click .pp-footer > a.pp-cancel":"close"},save:function(e){e&&e.preventDefault()},open:function(e){e&&e.preventDefault(),this.$el.addClass("pp-active").removeAttr("style")},close:function(e){e&&e.preventDefault(),this.$el.removeClass("pp-active")}}),AWEContent.Views.TemplateDialog=AWEContent.Views.Dialog.extend({id:"save-template-dialog",className:"md-popup",type:"section",savedElement:null,changedBgColor:!1,showMsg:!1,template:_.template('<div class="tb">                <div class="tb-cell">                    <div class="popup-inner">                        <div class="pp-heading"><h2>Section Template</h2></div>                        <div class="pp-body">                            <div class="pp-title">                                <h4>Title</h4>                                <input type="text">                                <span class="md-message">This field is required</span>                            </div>                            <div class="pp-content">                                <h4>Template Cover</h4>                                <div class="cover-uploader">                                    <input type="file">                                    <span><i>If you don\'t choose a cover image. An image will be auto generate base on template view.</i></span>                                </div>                                <div class="image-thumb" style="display: none">                                    <img src="" alt="">                                    <a href="#" class="remove-thumb" title="Remove">Ã—</a>                                </div>                            </div>                            <textarea id="ac-template-data" style="display: none"></textarea>                        </div>                        <div class="pp-footer">                            <a href="#" class="awe-actionbutton pp-save">Choose</a>                            <a href="#" class="pp-cancel">Cancel</a>                        </div>                    </div>                </div>            </div>'),initialize:function(){AWEContent.Views.Dialog.prototype.initialize.call(this),this.$el.append(this.template()),this.type=AWEContent.templateType,"page"==this.type&&e(".pp-heading h2",this.$el).html("Page template"),e(".remove-thumb",this.$el).click(function(t){t.preventDefault(),e(".image-thumb",self.$el).hide(),e(".cover-uploader",self.$el).show()})},open:function(t){e(".pp-title > input",this.$el).removeClass("pp-error").val(t.title),e(".pp-title > span.md-message",this.$el).hide(),e(".pp-content .cover-uploader input",this.$el).val(""),e("#ac-template-data",this.$el).val(JSON.stringify(t)),t.tid&&t.tid>0&&(e(".pp-content .cover-uploader").hide(),e(".pp-content .image-thumb > img").attr("src",t.thumbnail),e(".pp-content .image-thumb").show()),AWEContent.Views.Dialog.prototype.open.call(this)},save:function(t){AWEContent.Views.Dialog.prototype.save.call(this,t);var a=this,i=e(".pp-title > input",this.$el).val().trim();if(i){var l=JSON.parse(e("#ac-template-data",this.$el).val().trim());l.title=i,l.type=this.type,e(".image-thumb",this.$el).is(":visible")?a.uploadTemplate(!1,l,!0):e(".pp-content .cover-uploader > input",this.$el)[0].files.length?(a.uploadTemplate(e(".pp-content .cover-uploader > input",this.$el)[0].files[0],l),this.changedBgColor&&this.savedElement.css("background-color","")):("section"==this.type?(this.changedBgColor=!1,""==l.data.settings.bgColor&&(this.changedBgColor=!0,this.savedElement.css("background-color","#FFFFFF")),this.savedElement.removeClass("creating")):e(".awe-section",this.savedElement).removeClass("creating"),html2canvas(this.savedElement[0],{proxy:AWEContent.Path.templateProxy,onrendered:function(t){var i=t.height,s=t.width,p=t;i>1e3&&(s*=1e3/i,i=1e3,248>s&&(i*=248/s,s=248),p=AWEContent.compressImage(t,s,i)),a.uploadTemplate(p.toDataURL("image/jpg"),l),"section"==a.type?(a.changedBgColor&&a.savedElement.css("background-color",""),a.savedElement.addClass("creating")):e(".awe-section",a.savedElement).addClass("creating")},logging:!1,useCORS:!0,allowTaint:!1})),this.close()}else e(".pp-title > input",this.$el).addClass("pp-error"),e(".pp-title > span.md-message",this.$el).show()},uploadTemplate:function(t,a,i){var l=new FormData,s=new XMLHttpRequest;if("string"!=e.type(a)&&(a=JSON.stringify(a)),i)l.append("keep_thumbnail",1);else if(t)if("object"==e.type(t))l.append("thumbnailData",t);else{var p=this.spitThumbnailImageData(t);e.each(p,function(e,t){l.append("thumbnail_data_"+e,t)})}l.append("templateData",a),l.append("act","save_template"),(i||t)&&(s.open("POST",AWEContent.Path.uploadTemplate),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var t=JSON.parse(this.responseText.trim());1==t.status?(e(window).trigger("aweUploadTemplateSuccess",t.template),self.showMsg&&alert("Template has been created.")):alert(t.msg)}else console.log("Template upload failed")},s.send(l))},spitThumbnailImageData:function(e){for(var t=e.length,a=0,i=1e6,l=a+i,s=[];t>a;)s.push(e.slice(a,l)),a=l,l=a+i;return s}}),AWEContent.Views.PageTemplateDialog=AWEContent.Views.Dialog.extend({id:"page-templates-dialog",className:"md-popup",isReady:!1,template:_.template('<div class="tb">                <div class="tb-cell">                    <div class="popup-inner">                        <div class="pp-heading"><h2>Choose page template</h2></div>                        <div class="pp-body">                            <div class="awe-templates-list-wrapper">                                <div class="awe-templates-list clearfix">                                    <div class="awe-page-tpl-item active">                                        <div class="template-container">                                            <div class="template-thumbnail">                                                <div style="background-color: #d6d6d6; width: 220px; height: 260px"></div>                                            </div>                                            <h3 class="template-title">Blank</h3>                                            <input type="hidden" value="[]">                                        </div>                                    </div>                                </div>                                <div class="template-load-more">                                    <div class="awe-overlay" style="display: none">                                        <div id="followingBallsG">                                            <div id="followingBallsG_1" class="followingBallsG"></div>                                            <div id="followingBallsG_2" class="followingBallsG"></div>                                            <div id="followingBallsG_3" class="followingBallsG"></div>                                            <div id="followingBallsG_4" class="followingBallsG"></div>                                        </div>                                    </div>                                    <a href="#" class="awe-actionbutton pp-load-more">Load more</a>                                </div>                            </div>                        </div>                        <div class="pp-footer">                            <a href="#" class="awe-actionbutton pp-save">Choose</a>                            <a href="#" class="pp-cancel">Cancel</a>                        </div>                    </div>                </div>            </div>'),itemTemplate:_.template('<div class="awe-page-tpl-item">                <div class="template-container">                    <div class="template-thumbnail"><img alt="" src="<%= template.thumbnail %>" /></div>                    <h3 class="template-title"><%= template.title %></h3>                    <input type="hidden" value=\'<%= template.data %>\'>                </div>            </div>'),initialize:function(){var t=this;AWEContent.Views.Dialog.prototype.initialize.call(this),this.numberTemplates=0,this.allowLoadMore=!1,this.templateLoading=!1,this.$el.append(this.template),e(".awe-templates-list-wrapper",this.$el).perfectScrollbar().scroll(function(){if(t.allowLoadMore){var a=e(".ps-scroll-y-rail"),i=a.height(),l=e(".ps-scrollbar-y",a);i-l.height()-parseInt(l.css("top"))<10&&!t.templateLoading&&t.loadTemplates()}}),t.$el.delegate(".awe-page-tpl-item","click",function(a){if(e(this).hasClass("active")){var i=JSON.parse(e("input",e(this)).val().trim());t.close(a,i)}else e(".awe-page-tpl-item.active",t.$el).removeClass("active"),e(this).addClass("active")}),e(".pp-load-more",this.$el).click(function(e){e.preventDefault(),t.templateLoading||t.loadTemplates()}),this.isReady=!1,this.loadTemplates(!0)},loadTemplates:function(t){var a=this;this.templateLoading=!0,e(".awe-overlay",this.$el).show(),e(".pp-load-more",this.$el).hide(),e.post(AWEContent.Path.templateActionURL,{act:"load_templates",current:this.numberTemplates,type:"page"},function(i){i&&("string"==e.type(i)&&(i=JSON.parse(i.trim())),a.allowLoadMore=i.load_more,a.allowLoadMore?e(".template-load-more",a.$el).show():e(".template-load-more",a.$el).hide(),e.each(i.templates,function(){var t=this;e(".awe-templates-list",a.$el).append(a.itemTemplate({template:t}))}),e(".awe-templates-list-wrapper",this.$el).perfectScrollbar("update"),e(".ps-scrollbar-x-rail",a.$el).remove(),0==a.numberTemplates?a.numberTemplates+=i.templates.length-1:a.numberTemplates+=i.templates.length,t&&(a.isReady=!0),a.templateLoading=!1,e(".awe-overlay",a.$el).hide(),e(".pp-load-more",a.$el).show())})},save:function(t){if(AWEContent.Views.Dialog.prototype.save.call(this,t),e(".awe-page-tpl-item.active",this.$el).length){var a=JSON.parse(e(".awe-page-tpl-item.active input",this.$el).val().trim());return this.close(t,a),!0}alert("You must select a template.")},close:function(e,t){t&&this.$el.trigger("close",[t]),AWEContent.Views.Dialog.prototype.close.call(this,e)},open:function(t){AWEContent.Views.Dialog.prototype.open.call(this,t),e(".awe-page-tpl-item.active",this.$el).removeClass("active"),e(".awe-page-tpl-item:first",this.$el).addClass("active")}}),AWEContent.Views.SectionCategoriesDialog=AWEContent.Views.Dialog.extend({id:"edit-template-sections",className:"md-popup",template:_.template('<div class="tb">                <div class="tb-cell">                    <div class="popup-inner">                        <div class="pp-heading"><h2>Edit section category</h2></div>                        <div class="pp-body">                            <ul class="pp-list">                                <li>                                    <div class="pp-list-section">                                        <span class="pp-section-title" contenteditable="false">Header</span>                                        <div class="pp-control">                                            <div class="pp-control-item pp-sort" title="Sort">                                                <i class="ic ac-icon-move"></i>                                            </div>                                            <div class="pp-control-item pp-edit" title="Edit">                                                <i class="ic ac-icon-edit"></i>                                            </div>                                            <div class="pp-control-item pp-del" title="Delete">                                                <i class="ic ac-icon-trash"></i>                                            </div>                                        </div>                                    </div>                                </li>                            </ul>                        </div>                        <div class="pp-footer">                            <a href="#" class="awe-actionbutton pp-save">Save</a>                            <a href="#" class="pp-cancel">Cancel</a>                        </div>                    </div>                </div>            </div>            <div class="pp-list-section section-form-template" style="display: none">                <span class="pp-section-title" contenteditable="false">Header</span>                <div class="pp-control">                    <div class="pp-control-item pp-sort" title="Sort"><i class="ic ac-icon-move"></i></div>                    <div class="pp-control-item pp-edit" title="Edit"><i class="ic ac-icon-edit"></i></div>                    <div class="pp-control-item pp-del" title="Delete"><i class="ic ac-icon-trash"></i></div>                </div>            </div>'),initialize:function(){AWEContent.Views.Dialog.prototype.initialize.call(this);var t=this;this.$el.append(this.template()),e("ul.pp-list",this.$el).sortable({axis:"y",containment:"parent",handle:".pp-sort",tolerance:"pointer"}),this.$el.delegate(".pp-edit","click",function(){e(this).parent().prev().attr("contenteditable",!0).focus()}).delegate(".pp-del","click",function(){e(this).parents("li:first").hide()}).delegate(".pp-section-title","blur",function(){e(this).attr("contenteditable",!1)}),e(".ac-tpl-add-btn",this.$el).click(function(a){a.preventDefault();var i=e("<li></li>").append(e(".section-form-template",t.$el).clone().removeClass("section-form-template").removeAttr("style")),l=e(".pp-body ul.pp-list li",t.$el).length;e(".pp-section-title",i).text("Title"+l).attr("contenteditable",!0).focus(),e("ul.pp-list",t.$el).append(i)})},open:function(t){var a=this;e(".pp-body ul.pp-list",this.$el).empty(),t.each(function(){var t=e(this).data("filter").replace(".",""),i=e(this).html(),l=e("<li></li>").append(e(".section-form-template",a.$el).clone().removeClass("section-form-template").removeAttr("style"));e(".pp-section-title",l).text(i),l.attr("data-machine-name",t),e(".pp-body ul.pp-list",a.$el).append(l)}),AWEContent.Views.Dialog.prototype.open.call(this)},save:function(t){if(t&&t.preventDefault(),confirm(Drupal.t("All change will be saved to server and could not restore. Are you sure?"))){var a=this,i=[];e(".pp-body ul.pp-list li",this.$el).each(function(){var t=e(".pp-section-title",e(this)).text(),a={deleted:0,title:t,machineName:e(this).data("machine-name")?e(this).data("machine-name"):t.toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/^-|-$]/g,"")};e(this).is(":visible")||(a.deleted=1),i.push(a)}),e.post(AWEContent.Path.templateActionURL,{act:"up_sec_categories",sections:i},function(t){t.status?(a.$el.removeClass("pp-active"),e("#filters ul.template-filter a:not(#all, #favourite)").each(function(){e(this).parent().remove()}),e("#save-template-dialog .pp-categories select").empty(),e.each(t.sections,function(t,a){e("#filters ul.template-filter").append('<li><a href="#" data-filter=".'+t+'">'+a+"</a></li>")})):alert(Drupal.t("Server update section categories failed."))})}AWEContent.Views.Dialog.prototype.save.call(this)}})}(jQuery);